# Progress

- Added review defaults to DEFAULT_REPO_CONFIG with agent=opencode and model=zai-coding-plan/glm-4.7
- Added "review" to REPO_DEFAULT_KEYS
- Added housekeeping rule for .codex-autorunner/review/runs in DEFAULT_REPO_CONFIG
- Implemented core/review.py ReviewService with:
  - Lock/state/thread pattern following pr_flow.py design
  - Run dir creation under .codex-autorunner/review/runs/<run_id>/
  - Scratchpad directory creation
  - OpenCode prompt execution with session management
  - Final report read and validation
  - Optional scratchpad zip bundle creation
  - Robust status transitions (idle → running → completed/failed/stopped/interrupted)
  - Worker PID tracking and process alive detection
- Added reusable OpenCode prompt runner helper in src/codex_autorunner/agents/opencode/run_prompt.py:
  - OpenCodeRunConfig dataclass for configuration
  - OpenCodeRunResult dataclass for results
  - run_opencode_prompt function that wraps common pattern:
    - Session creation
    - Env var validation
    - Prompt execution
    - Output collection
    - Stop/timeout/interrupt handling
  - Adopted by ReviewService (simplified _run_review_async significantly)
  - Helper can optionally be adopted by DocChatService later to reduce duplication
- Added review API schemas in src/codex_autorunner/web/schemas.py:
  - ReviewStartRequest (agent/model/reasoning/max_wallclock_seconds)
  - ReviewStatusResponse (review dict)
  - ReviewControlResponse (status/detail)
- Added routes/review.py with:
  - GET /api/review/status - returns review state
  - POST /api/review/start - starts a new review run
  - POST /api/review/stop - stops running review
  - POST /api/review/reset - resets review state
  - GET /api/review/artifact - serves artifacts (final_report/workflow_log/scratchpad_bundle)
  - Safety checks: paths must be within repo root and contain .codex-autorunner in path parts
- Wired review routes into routes/__init__.py
- Added Review dashboard card to index.html with:
  - Controls: agent/model/reasoning/timeout inputs
  - Status: run ID, started, finished
  - Buttons: start/stop/reset
  - Artifact links: final report, log, scratchpad bundle
- Created review.js with status polling and initReview function
- Wired initReview in app.js
- Added review.css styles for review card layout and artifacts
- Updated static/utils.js statusPill to handle "failed" and "stopping" states
- Added tests/test_review_service.py with comprehensive tests:
  - State transitions (idle → running → stopped/idle)
  - Run dir and scratchpad creation
  - Default agent/model values
  - Custom config acceptance
  - Non-opencode agent rejection
  - Lock file management
  - Busy state detection
  - Repo busy check
  - Artifact paths in state
  - Thread liveness detection
  - Interrupted recovery
- Updated tests/test_api_contract.py to include review endpoints (/api/review/status, /api/review/start, /api/review/stop, /api/review/reset, /api/review/artifact)
- Fixed config.py issues: added "review" to REPO_DEFAULT_KEYS at top-level, added review config section to DEFAULT_REPO_CONFIG, added review_runs housekeeping rule to housekeeping.rules
- Optional UI test skipped: Test setup complexity in conftest.py would require significant refactoring to avoid conflicts with existing tests
- All Review feature implementation complete and functional: backend service, API routes, frontend UI, and tests
